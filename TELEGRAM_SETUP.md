# Настройка Telegram-бота для подтверждения заказов

## 1. Создание бота

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Введите имя бота (например: "Магазин для попугаев")
4. Введите username бота (например: `parrot_shop_bot`)
5. Сохраните полученный токен

## 2. Настройка переменных окружения

Добавьте в `.env.local`:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
TELEGRAM_BOT_USERNAME=ваш_username_бота
TELEGRAM_CHAT_ID=ваш_chat_id
```

## 3. Получение Chat ID

### Вариант 1: Через API
1. Запустите сервер: `npm run dev`
2. Откройте бота в Telegram и отправьте `/start`
3. Откройте в браузере: `http://localhost:5000/api/telegram-setup`
4. Скопируйте Chat ID из ответа

### Вариант 2: Через скрипт
1. Запустите: `get-telegram-chat-id.bat`
2. Следуйте инструкциям

## 4. Настройка вебхука (для продакшена)

После деплоя на сервер настройте вебхук:

```bash
curl -X POST "https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://ваш-домен.com/api/telegram/webhook"}'
```

Для локальной разработки вебхук не нужен - бот работает через long polling.

## 5. Как это работает

### Процесс заказа:

1. **Клиент оформляет заказ** на сайте
2. **Система создает заказ** с уникальным `telegramOrderId`
3. **Клиент видит ссылку** на Telegram-бота с deep link
4. **Клиент переходит в бота** по ссылке `https://t.me/bot_username?start=ORDER_ID`
5. **Бот показывает детали заказа** с кнопками "Подтвердить" / "Отменить"
6. **Клиент подтверждает заказ** нажатием кнопки
7. **Статус обновляется** в базе данных
8. **Менеджер получает уведомление** в админ-чат
9. **Клиент может общаться** с менеджером прямо в боте

### Команды бота:

- `/start` - приветствие
- `/start ORDER_ID` - подтверждение конкретного заказа (deep link)

### Статусы заказа:

- `new` - создан, ожидает подтверждения
- `confirmed` - подтвержден клиентом в боте
- `processing` - в обработке
- `completed` - выполнен
- `cancelled` - отменен

## 6. Тестирование

1. Запустите сервер: `npm run dev`
2. Создайте тестовый заказ на сайте
3. Перейдите по ссылке на бота
4. Подтвердите заказ
5. Проверьте, что статус обновился

### Тест уведомлений:

```bash
curl http://localhost:5000/api/test-telegram
```

## 7. Troubleshooting

### Бот не отвечает
- Проверьте правильность токена
- Убедитесь, что бот не заблокирован

### Не приходят уведомления
- Проверьте `TELEGRAM_CHAT_ID`
- Убедитесь, что вы отправили `/start` боту

### Ошибка вебхука
- Проверьте, что URL доступен извне
- Убедитесь, что используется HTTPS

## 8. Безопасность

- Никогда не коммитьте `.env.local` в Git
- Храните токен бота в секрете
- Используйте HTTPS для вебхуков
- Валидируйте все входящие данные от Telegram
